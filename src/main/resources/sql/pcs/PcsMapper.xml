<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.happyjob.study.pcs.dao.PcsDao">
	<!-- 발주지시서 목록 조회 -->
	<select id="pcsOrderingOrder" resultType="kr.happyjob.study.pcs.model.PcsModel">
		/*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
      SELECT 
            DISTINCT
             PL.purch_list_no
         ,   PL.order_cd
         ,   PL.supply_cd
         ,   SP.supply_nm
         ,   PD.prod_nm
         ,   PD.m_ct_cd
         ,   PL.purch_qty
         ,   PD.purchase_price
         ,   PL.desired_delivery_date
         ,   WH.warehouse_nm
         ,   PL.purch_mng_id
         ,   PL.scm_id
      FROM tb_scm_purchase_list as PL
          LEFT JOIN tb_order as OD
          ON PL.order_cd = OD.order_cd
          LEFT JOIN tb_scm_product as PD
          ON OD.product_cd = PD.product_cd
          LEFT JOIN tb_scm_supply as SP
          ON PD.supply_cd = SP.supply_cd
          LEFT JOIN tb_scm_warehouse as WH
          ON SP.warehouse_cd = WH.warehouse_cd
      ORDER BY purch_list_no DESC
	</select>

	<!-- 발주지시서 목록 조회  원본-->
	<select id="pcsOrderingOrderOriginal" resultType="kr.happyjob.study.pcs.model.PcsModel">
		/*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
      SELECT 
            DISTINCT
             PL.purch_list_no
         ,   PL.order_cd
         ,   PL.supply_cd
         ,   SP.supply_nm
         ,   PD.prod_nm
         ,   PD.m_ct_cd
         ,   PL.purch_qty
         ,   PD.purchase_price
         ,   PL.desired_delivery_date
         ,   WH.warehouse_nm
         ,   PL.purch_mng_id
      FROM tb_scm_purchase_list as PL
          LEFT JOIN tb_order as OD
        ON PL.order_cd = OD.order_cd
        LEFT JOIN tb_scm_warehouse as WH
        ON OD.warehouse_cd = WH.warehouse_cd  
        LEFT JOIN tb_scm_supply as SP
        ON PL.supply_cd = SP.supply_cd
        LEFT JOIN tb_scm_product as PD
        ON PL.supply_cd = PD.supply_cd
      ORDER BY purch_list_no DESC
	</select>

	<!-- 발주지시서 목록 총 갯수 조회 -->
	<select id="countPcsOrderingOrder" resultType="int">
		/*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
		SELECT COUNT(1) AS tot_cnt 
      FROM tb_scm_purchase_list as PL
          LEFT JOIN tb_order as OD
        ON PL.order_cd = OD.order_cd
        LEFT JOIN tb_scm_warehouse as WH
        ON OD.warehouse_cd = WH.warehouse_cd
	</select>
	
	 <!-- 발주지시서 버튼 -->
  <select id="selectPurchBtn" resultType="kr.happyjob.study.pcs.model.PcsModel">
    /*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
      SELECT 
           DISTINCT
             PL.purch_list_no
         ,   SP.supply_nm
         ,   PD.prod_nm
         ,   PD.m_ct_cd
         ,   PL.purch_qty
         ,   PD.purchase_price
         ,   PL.desired_delivery_date
         ,   WH.warehouse_nm
         ,   PL.purch_mng_id
         ,   PL.supply_cd
         ,   DC.detail_name
      FROM tb_scm_purchase_list as PL
          LEFT JOIN tb_order as OD
        ON PL.order_cd = OD.order_cd
        LEFT JOIN tb_scm_warehouse as WH
        ON OD.warehouse_cd = WH.warehouse_cd  
        LEFT JOIN tb_scm_supply as SP
        ON PL.supply_cd = SP.supply_cd
        LEFT JOIN tb_scm_product as PD
        ON OD.product_cd = PD.product_cd
        LEFT JOIN (
            SELECT detail_code, group_code, detail_name
          FROM tb_detail_code
          WHERE group_code = 'STTcd'
        ) DC ON OD.STTcd = DC.detail_code
     WHERE PL.purch_list_no = #{purch_list_no}
       AND PL.order_cd = #{order_cd}
       AND PL.supply_cd = #{supply_cd}
       AND PD.product_cd = #{product_cd}
  </select>
  
  <!-- 발주서 목록 조회 -->
  <select id="pcsOrderForm" resultType="kr.happyjob.study.pcs.model.PcsModel">
    /*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
        SELECT 
            DISTINCT
             PL.purch_list_no
         ,   OD.order_cd
         ,   SP.supply_nm
         ,   PD.prod_nm
         ,   PD.product_cd
         ,   PD.m_ct_cd
         ,   PL.purch_qty
         ,   WH.warehouse_nm
         ,   PL.direction_date
         ,   PL.desired_delivery_date
         ,   OD.STTcd
         ,   PL.supply_cd
         ,   DC.detail_name
      FROM tb_scm_purchase_list as PL
        LEFT JOIN tb_order as OD
        ON PL.order_cd = OD.order_cd
        LEFT JOIN tb_scm_product as PD
        ON OD.product_cd = PD.product_cd
        LEFT JOIN tb_scm_supply as SP
        ON PD.supply_cd = SP.supply_cd
        LEFT JOIN tb_scm_warehouse as WH
        ON SP.warehouse_cd = WH.warehouse_cd
        LEFT JOIN (
            SELECT detail_code, group_code, detail_name
          FROM tb_detail_code
          WHERE group_code = 'STTcd'
        ) DC ON OD.STTcd = DC.detail_code
        <where>
		       <if test="(search_type != null) and (!search_type.equals(''))">
		        <choose>
			        <when test="(search_type != null) and (search_type eq 'brand'.toString())">
			          and PD.m_ct_cd Like CONCAT('%', #{adm_key}, '%')
			        </when>
			        <when test="(search_type != null) and (search_type eq 'product'.toString())">
			          and PD.prod_nm LIKE CONCAT('%', #{adm_key}, '%')
			        </when>
			        <when test="(search_type != null) and (search_type eq 'all'.toString())">
			          and (PD.m_ct_cd LIKE CONCAT('%', #{adm_key}, '%') or PD.prod_nm LIKE CONCAT('%', #{adm_key}, '%'))
			        </when>
		        </choose>
		      </if>
		    </where>
      WHERE OD.STTcd = 2
         OR OD.STTcd = 12
      ORDER BY purch_list_no DESC;
  </select>
  
  <!-- 발주서 목록 조회 원본-->
  <select id="pcsOrderFormOriginal" resultType="kr.happyjob.study.pcs.model.PcsModel">
    /*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
        SELECT 
             PL.purch_list_no
         ,   OD.order_cd
         ,   SP.supply_nm
         ,   PD.prod_nm
         ,   PD.product_cd
         ,   PD.m_ct_cd
         ,   PL.purch_qty
         ,   WH.warehouse_nm
         ,   PL.direction_date
         ,   PL.desired_delivery_date
         ,   OD.STTcd
         ,   PL.supply_cd
         ,   DC.detail_name
      FROM tb_scm_purchase_list as PL
        LEFT JOIN tb_order as OD
        ON PL.order_cd = OD.order_cd
        LEFT JOIN tb_scm_warehouse as WH
        ON OD.warehouse_cd = WH.warehouse_cd
        LEFT JOIN tb_scm_supply as SP
        ON PL.supply_cd = SP.supply_cd
        LEFT JOIN tb_scm_product as PD
        ON PL.supply_cd = PD.supply_cd
        LEFT JOIN (
            SELECT detail_code, group_code, detail_name
          FROM tb_detail_code
          WHERE group_code = 'STTcd'
        ) DC ON OD.STTcd = DC.detail_code
      WHERE OD.STTcd = 2
      ORDER BY purch_list_no DESC
  </select>
  
  <!-- 발주서 목록 총 갯수 조회 -->
  <select id="countPcsOrderForm" resultType="int">
    /*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
    SELECT COUNT(1) AS tot_cnt 
      FROM tb_scm_purchase_list as PL
          LEFT JOIN tb_order as OD
        ON PL.order_cd = OD.order_cd
        LEFT JOIN tb_scm_warehouse as WH
        ON OD.warehouse_cd = WH.warehouse_cd
  </select>
  
  <!-- 발주서 상태 변경 -->
  <update id="updateSTTcd">
    /*kr.kosmo.jobkorea.pcs.dao.PcsDao*/
    UPDATE tb_order
       SET STTcd = 12 
     WHERE STTcd = 2;
  </update>
</mapper>